const express = require('express');
const router = express.Router();
const Usuario = require('../models/usuario'); // AsegÃºrate de que la ruta al modelo es correcta

router.get('/completed-levels/:userId', (req, res) => {
  const { userId } = req.params;
  Usuario.getCompletedLevels(userId, (err, row) => {
    if (err) {
      return res.status(500).json({ success: false, message: 'Error obteniendo niveles completados', error: err.message });
    }
    res.json({ success: true, levels: row.NivelesCompletados ? row.NivelesCompletados.split(',') : [] });
  });
});

router.put('/update-profile', (req, res) => {
  const { userId, nombre, correo, password } = req.body;

  // Verificar si el correo ya existe para otro usuario
  const query = `SELECT id FROM Usuario WHERE Correo = ? AND id != ?`;
  db.get(query, [correo, userId], (err, row) => {
    if (err) {
      return res.status(500).json({ success: false, message: 'Error en la consulta', error: err.message });
    }
    if (row) {
      return res.status(409).json({ success: false, message: 'El correo ya existe.' });
    }

    // Actualizar el perfil del usuario
    const updateQuery = `UPDATE Usuario SET Nombre = ?, Correo = ?, Password = ? WHERE id = ?`;
    db.run(updateQuery, [nombre, correo, password, userId], function(err) {
      if (err) {
        return res.status(500).json({ success: false, message: 'Error al actualizar el perfil', error: err.message });
      }
      res.json({ success: true, message: 'Perfil actualizado correctamente' });
    });
  });
});

module.exports = router;
