const express = require('express');
const router = express.Router();
const Usuario = require('../models/usuario'); 
const db = require('../backend/db');


router.get('/completed-levels/:userId', (req, res) => {
  const { userId } = req.params;
  Usuario.getCompletedLevels(userId, (err, row) => {
    if (err) {
      return res.status(500).json({ success: false, message: 'Error obteniendo niveles completados', error: err.message });
    }
    res.json({ success: true, levels: row.NivelesCompletados ? row.NivelesCompletados.split(',') : [] });
  });
});

router.put('/update-profile', (req, res) => {
  const { userId, nombre, correo, password } = req.body;

  // Verificar si el correo ya existe para otro usuario
  const query = `SELECT id FROM Usuario WHERE Correo = ? AND id != ?`;
  db.get(query, [correo, userId], (err, row) => {
    if (err) {
      return res.status(500).json({ success: false, message: 'Error en la consulta', error: err.message });
    }
    if (row) {
      return res.status(409).json({ success: false, message: 'El correo ya existe.' });
    }

    // Actualizar el perfil del usuario
    const updateQuery = `UPDATE Usuario SET Nombre = ?, Correo = ?, Password = ? WHERE id = ?`;
    db.run(updateQuery, [nombre, correo, password, userId], function(err) {
      if (err) {
        return res.status(500).json({ success: false, message: 'Error al actualizar el perfil', error: err.message });
      }
      res.json({ success: true, message: 'Perfil actualizado correctamente' });
    });
  });
});

// Obtener todos los usuarios
router.get('/admin/users', (req, res) => {
  const query = 'SELECT id, Nombre, Correo FROM Usuario';
  db.all(query, [], (err, rows) => {
    if (err) {
      return res.status(500).json({ success: false, message: 'Error obteniendo usuarios', error: err.message });
    }
    res.json({ success: true, users: rows });
  });
});


// Eliminar un usuario por id
router.delete('/admin/users/:id', (req, res) => {
  const { id } = req.params;
  const query = 'DELETE FROM Usuario WHERE id = ?';
  db.run(query, [id], function(err) {
    if (err) {
      return res.status(500).json({ success: false, message: 'Error al eliminar usuario', error: err.message });
    }
    res.json({ success: true, message: 'Usuario eliminado correctamente' });
  });
});



module.exports = router;